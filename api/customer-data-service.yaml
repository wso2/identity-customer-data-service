openapi: 3.0.0
info:
  title: Custodian API
  description: API documentation for customer data service.
  version: 0.0.1
servers:
  - url: http://localhost:8080/t/{org_id}/api/v1

paths:
  /profiles:
    get:
      tags: [Profile]
      summary: Get all profiles
      operationId: getAllProfiles
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Profile'

  /profiles/{profile_id}:
    post:
        tags: [Profile]
        summary: Create profile
        operationId: createProfile
        security:
            - bearerAuth: [ ]
        requestBody:
            required: true
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/Profile'
        responses:
          '201':
            description: Profile created successfully
          '400':
            description: Bad request, invalid profile data

    get:
      tags: [Profile]
      summary: Retrieve profile by Id
      operationId: getProfile
      parameters:
        - name: profile_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Profile retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Profile'
    patch :
      tags: [Profile]
      summary: Update profile by Id
      operationId: updateProfile
      parameters:
        - name: profile_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Profile'
      responses:
        '200':
          description: Profile updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Profile'
    delete:
      tags: [Profile]
      summary: Delete profile by Id
      operationId: deleteProfile
      parameters:
        - name: profile_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Profile deleted successfully

  /unification-rules:
    post:
      tags: [Profile Unification]
      summary: Add new unification rule
      operationId: addUnificationRule
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UnificationRule'
      responses:
        '201':
          description: Unification rule added successfully
    get:
      tags: [Profile Unification]
      summary: Get all unification rules
      operationId: getUnificationRules
      responses:
        '200':
          description: Unification rules retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UnificationRule'

  /unification-rules/{rule_id}:
    get:
      tags: [Profile Unification]
      summary: Get unification rule rule by ID
      operationId: getUnificationRule
      parameters:
        - name: rule_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Unification rule retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnificationRule'
    patch:
      tags: [ Profile Unification ]
      summary: Patch unification rule
      operationId: patchUnificationRule
      parameters:
        - name: rule_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UnificationRulePatch'
      responses:
        '200':
          description: Unification rule retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnificationRule'
    delete:
      tags: [Profile Unification]
      summary: Delete unification rule
      operationId: deleteUnificationRule
      parameters:
        - name: rule_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Rule deleted successfully

  /profile-schema:
    post:
      tags: [Profile Schema]
      summary: Add profile schema attribute
      operationId: addProfileSchemaAttribute
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProfileSchema'
      responses:
        '201':
          description: Rule created successfully
    get:
      tags: [Profile Schema]
      summary: Get all profile enrichment rules
      operationId: getProfileSchema
      responses:
        '200':
          description: Rule retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ProfileSchema'

  /profile-schema/{attribute_id}:
    get:
      tags: [Profile Schema]
      summary: Get profile schema attribute rule by ID
      operationId: getProfileSchemaAttribute
      parameters:
        - name: attribute_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Trait retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProfileSchema'
    put:
      tags: [Profile Schema]
      summary: Update profile Schema Attribute
      operationId: putProfileSchemaAttribute
      parameters:
        - name: attribute_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProfileSchema'
      responses:
        '200':
          description: Rule updated successfully
    delete:
      tags: [Profile Schema]
      summary: Delete profile schema attribute
      operationId: deleteProfileSchemaAttribute
      parameters:
        - name: attribute_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Rule deleted successfully

  /consents:
    post:
      tags: [consent]
      summary: Give or update consent
      operationId: giveConsent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Consent'
      responses:
        '201':
          description: Consent saved successfully

  /consents/{profile_id}:
    get:
      tags: [consent]
      summary: Get all consents for a user
      operationId: getUserConsents
      parameters:
        - name: profile_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: List of consents
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Consent'

    delete:
      tags: [consent]
      summary: Revoke all consents for a user
      operationId: revokeAllConsents
      parameters:
        - name: profile_id
          in: path
          required: true
          schema:
            type: string
        - name: consent_type
          in: query
          required: false
          schema:
            type: string
        - name: category
          in: query
          required: false
          schema:
            type: string
      responses:
        '204':
          description: Consent(s) revoked

  /consent-categories:
    get:
      tags: [Consent Configurations]
      summary: Get all consent categories
      operationId: getAllConsentCategories
      responses:
        '200':
          description: List of consent categories
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ConsentCategory'
    post:
      tags: [Consent Configurations]
      summary: Add consent category
      operationId: addConsentCategory
      responses:
        '200':
          description: Consent category added successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConsentCategory'
  /consent-categories/{id}:
    get:
      tags: [Consent Configurations]
      summary: Get consent category
      operationId: getConsentCategory
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Consent category
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConsentCategory'
    put:
      tags: [Consent Configurations]
      summary: Update consent category
      operationId: updateConsentCategory
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Consent category updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConsentCategory'

components:
  schemas:
    Profile:
      type: object
      properties:
        profile_id:
          type: string
        user_id:
          type: string
        identity_attributes:
          example: {"email":"random@work.com"}
        traits:
          type: object
          example: {"shopper":"true"}
        application_data:
          type: array
          items:
            $ref: '#/components/schemas/ApplicationData'
        merged_to:
          $ref: '#/components/schemas/ProfileReferences'
        merged_from:
          $ref: '#/components/schemas/ProfileReferences'
    ProfileReferences:
      type: object
      properties:
        reference_profile_id:
          type: string
        reference_reason:
          type: string

    ApplicationData:
      type: object
      properties:
        application_id:
          type: string
          example: "40497337-e8bf-4d92-9545-711894ab2af3"


    ProfileSchema:
      type: object
      properties:
        attribute_id:
          type: string
        attribute_name:
          type: string
        value_type:
          type: string
        computation_method:
          type: string
          enum: [static, extract, count]
        multi_valued:
          type: boolean
        mutability:
          type: string
          enum: [ readWrite, readOnly, immutable ]
        application_identifier:
          type: string
        merge_strategy:
          type: string
          enum: [overwrite, combine, latest, oldest]
        canonical_values:
          type: array
          items:
            type: object
            properties:
              value:
                type: string
              label:
                type: string
        sub_attributes:
          type: array
          items:
            type : object
            properties:
              attribute_id:
                type: string
              attribute_name:
                type: string

    RuleTrigger:
      type: object
      properties:
        event_type:
          type: string
        event_name:
          type: string
        conditions:
          type: array
          items:
            $ref: '#/components/schemas/RuleCondition'

    RuleCondition:
      type: object
      properties:
        field:
          type: string
        operator:
          type: string
        value:
          type: string

    UnificationRule:
      type: object
      required:
        - rule_name
        - attribute
        - priority
        - is_active
      properties:
        rule_id:
          type: string
          format: uuid
          description: Unique identifier for the resolution rule
          example: "5af4235d-b95e-4b5b-9429-c9021e653361"
        rule_name:
          type: string
          description: Descriptive name for the rule
          example: "user id based"
        attribute:
          type: string
          description: Attribute path to be used for unification
          example: "identity.user_id"
        priority:
          type: integer
          description: Priority of the rule (lower number = higher priority)
          example: 1
        is_active:
          type: boolean
          description: Whether the rule is currently active
          example: true
        created_at:
          type: integer
          format: int64
          description: UNIX timestamp of creation
          example: 1744176544
        updated_at:
          type: integer
          format: int64
          description: UNIX timestamp of last update
          example: 1744176544

    UnificationRulePatch:
      type: object
      properties:
        rule_name:
          type: string
          description: Descriptive name for the rule
          example: "user id based"
        priority:
          type: integer
          description: Priority of the rule (lower number = higher priority)
          example: 1
        is_active:
          type: boolean
          description: Whether the rule is currently active
          example: true

    ConsentCategory:
      type: object
      required:
        - category_name
        - category_identifier
        - purpose
      properties:
        id:
          type: string
          format: uuid
          example: 7fa06d1e-688f-481b-8263-29c1f5ce1493
        category_name:
          type: string
          example: User behavior analytics
        category_identifier:
          type: string
          example: analytics
        purpose:
          type: string
          enum: [profiling, personalization, destination]
        destinations:
          type: array
          items:
            type: string

    Consent:
      type: object
      required:
        - profile_id
        - application_id
        - consent_type
        - granted
        - categories
        - consent_channel
        - timestamp
      properties:
        consent_id:
          type: string
          format: uuid
          example: "6d2ff26e-12aa-4b3d-b1d6-c7f7b6b7c7e1"
        profile_id:
          type: string
          example: "12345"
        application_id:
          type: string
          example: "custodian_client_app"
        category_identifier:
          type: string
          example: "analytics"
        granted:
          type: boolean
          example: true
        consent_channel:
          type: string
          description: Source of consent
          example: "web"
        timestamp:
          type: integer
          format: int64
          example: 1744339000
        source_ip:
          type: string
          example: "192.168.1.10"
        user_agent:
          type: string
          example: "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)"
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
#        bearerFormat: JWT  # ⚠️ Optional. You can even remove this if you allow both JWT & opaque.